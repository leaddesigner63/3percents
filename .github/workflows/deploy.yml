name: Deploy 3percents

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY_B64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          SSH_PORT="${{ secrets.DEPLOY_PORT }}"
          if [ -z "${SSH_PORT}" ]; then
            SSH_PORT="22"
          fi

          rm -f ~/.ssh/known_hosts
          ssh-keyscan -p "${SSH_PORT}" -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        shell: bash
        run: |
          set -euo pipefail

          SSH_PORT="${{ secrets.DEPLOY_PORT }}"
          if [ -z "${SSH_PORT}" ]; then
            SSH_PORT="22"
          fi

          ssh -i ~/.ssh/id_ed25519 -p "${SSH_PORT}" \
            -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}" \
            REPO_URL="https://github.com/${{ github.repository }}.git" \
            SERVICE_NAME="${{ secrets.SERVICE_NAME }}" \
            bash -s <<'EOF'
          set -euo pipefail

          : "${PROJECT_DIR:?ERROR: PROJECT_DIR secret is empty.}"

          mkdir -p "${PROJECT_DIR}"
          cd "${PROJECT_DIR}"

          if [ ! -d .git ]; then
            git clone --depth 1 "${REPO_URL}" .
          else
            git pull --ff-only
          fi

          python -m venv venv
          venv/bin/python -m pip install -r requirements.txt
          systemctl restart "${SERVICE_NAME}"
          EOF
