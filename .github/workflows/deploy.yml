name: Deploy 3percents

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY_B64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          SSH_PORT="${{ secrets.DEPLOY_PORT }}"
          if [ -z "${SSH_PORT}" ]; then
            SSH_PORT="22"
          fi

          rm -f ~/.ssh/known_hosts
          ssh-keyscan -p "${SSH_PORT}" -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        shell: bash
        run: |
          set -euo pipefail

          SSH_PORT="${{ secrets.DEPLOY_PORT }}"
          if [ -z "${SSH_PORT}" ]; then
            SSH_PORT="22"
          fi

          ssh -i ~/.ssh/id_ed25519 -p "${SSH_PORT}" \
            -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}" \
            REPO_URL="https://github.com/${{ github.repository }}.git" \
            SERVICE_NAME="${{ secrets.SERVICE_NAME }}" \
            bash -s <<'EOF'
          set -euo pipefail

          : "${PROJECT_DIR:?ERROR: PROJECT_DIR secret is empty.}"

          mkdir -p "${PROJECT_DIR}"
          cd "${PROJECT_DIR}"
          git config --global --add safe.directory "${PROJECT_DIR}"

          if [ ! -d .git ]; then
            git init
            git remote add origin "${REPO_URL}"
            git fetch --depth 1 origin main
            git checkout -f main
            git reset --hard origin/main
            git clean -fdx
          else
            git fetch origin main
            git reset --hard origin/main
            git clean -fdx
          fi

          if [ ! -d .venv ]; then
            python3 -m venv .venv
          fi
          .venv/bin/python -m pip install -r requirements.txt
          UNIT_PATH="/etc/systemd/system/${SERVICE_NAME}.service"
          if [ -f "telegram-carousel-bot.service" ]; then
            if [ -w "${UNIT_PATH}" ] || [ -w "$(dirname "${UNIT_PATH}")" ]; then
              cp "telegram-carousel-bot.service" "${UNIT_PATH}"
              systemctl daemon-reload
            elif command -v sudo >/dev/null 2>&1 && sudo -n true; then
              sudo cp "telegram-carousel-bot.service" "${UNIT_PATH}"
              sudo systemctl daemon-reload
            else
              echo "WARNING: нет прав на обновление systemd unit-файла (${UNIT_PATH})." >&2
            fi
          fi

          if command -v sudo >/dev/null 2>&1 && ! [ "$(id -u)" -eq 0 ]; then
            sudo systemctl restart "${SERVICE_NAME}"
          else
            systemctl restart "${SERVICE_NAME}"
          fi
          EOF
